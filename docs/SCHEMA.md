# Database Schema & Data Model

> Complete reference for Happenlist's data model. Written for both developers
> and non-technical admins who need to understand how data is organized.

For Chrome extension/scraper API reference, see [CHROME-EXTENSION.md](./CHROME-EXTENSION.md). For feature guides, see [FEATURES.md](./FEATURES.md).

---

## How to Think About the Data

Happenlist stores **events** — things happening at specific places and times. Everything else supports events:

| Concept | Table | What it is | Example |
|---------|-------|------------|---------|
| **Event** | `events` | A single thing happening on a specific date | "Jazz Night - Feb 14" |
| **Series** | `series` | A group of related events | "Pottery 101 (6-week class)" |
| **Venue** | `locations` | A place where events happen | "Pabst Theater" |
| **Organizer** | `organizers` | Who runs the event | "Milwaukee Jazz Collective" |
| **Category** | `categories` | What kind of event | "Music", "Art", "Classes" |

---

## Entity Hierarchy

```
ORGANIZER (who)
  └── SERIES (optional grouping)
       └── EVENT (what + when)
            ├── CATEGORY (what kind)
            └── LOCATION (where)
```

**An event always has:** a title, a date, and a status.
**An event usually has:** a category, a location, and an organizer.
**An event sometimes has:** a series (if it's part of a class, camp, etc.).

### For CSV Exports

When exporting events as a CSV, each row is one event. Related data (category, venue, organizer, series) is joined in as flat columns. Here's a recommended CSV structure:

| CSV Column | Source | Example |
|------------|--------|---------|
| `event_title` | `events.title` | "Jazz Night" |
| `event_date` | `events.instance_date` | "2026-02-14" |
| `start_time` | `events.start_datetime` | "2026-02-14T19:00:00" |
| `end_time` | `events.end_datetime` | "2026-02-14T22:00:00" |
| `status` | `events.status` | "published" |
| `short_description` | `events.short_description` | "Live jazz at the Pabst" |
| `description` | `events.description` | Full description text |
| `price_type` | `events.price_type` | "range" |
| `price_low` | `events.price_low` | 15 |
| `price_high` | `events.price_high` | 50 |
| `price_details` | `events.price_details` | "GA $15-30, VIP $50" |
| `is_free` | `events.is_free` | false |
| `category_name` | `categories.name` (via `events.category_id`) | "Music" |
| `venue_name` | `locations.name` (via `events.location_id`) | "Pabst Theater" |
| `venue_address` | `locations.address_line` | "144 E Wells St" |
| `venue_city` | `locations.city` | "Milwaukee" |
| `organizer_name` | `organizers.name` (via `events.organizer_id`) | "MKE Jazz Collective" |
| `series_title` | `series.title` (via `events.series_id`) | "Winter Jazz Series" |
| `series_type` | `series.series_type` (via `events.series_id`) | "recurring" |
| `image_url` | `events.image_url` | URL to event image |
| `website_url` | `events.website_url` | External event page |
| `source` | `events.source` | "manual", "scraper", etc. |
| `age_restriction` | `events.age_restriction` | "21+" |
| `is_family_friendly` | `events.is_family_friendly` | true |
| `heart_count` | `events.heart_count` | 42 |

---

## Tables Reference

### 1. events (the core table)

Every row is one event on one date.

#### Identity

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | UUID | auto | Primary key, auto-generated |
| `title` | text | **yes** | Event name. Min 3, max 200 characters. Example: "Jazz Night at the Pabst" |
| `slug` | text | **yes** | URL-friendly version of title, auto-generated. Must be unique. Example: `jazz-night-at-the-pabst` |
| `created_at` | timestamp | auto | When the row was created |
| `updated_at` | timestamp | auto | When the row was last modified |
| `published_at` | timestamp | no | When the event was first set to `published` status |

#### Description

See [Description Fields](#description-fields-on-events) for how these map to the UI.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `description` | text | no | General cleaned-up description. Not displayed on the detail page; used as SEO fallback when `meta_description` and `short_description` are missing. |
| `short_description` | text | no | One-line teaser for cards and SEO. Max ~160 characters. Example: "Live jazz at the Pabst Theater" |
| `happenlist_summary` | text | no | Editorial third-person summary, AI-generated by the scraper from the organizer_description. Shown in a highlighted "Highlights" box on detail page. |
| `organizer_description` | text | no | Verbatim description from the event source. Preserves original formatting/voice. Shown in a quoted "From the Organizer" section. |

#### When

| Field | Type | Required | Description | Example |
|-------|------|----------|-------------|---------|
| `start_datetime` | timestamp | **yes** | Event start date and time in ISO 8601. | `2026-02-14T19:00:00-06:00` |
| `end_datetime` | timestamp | no | Event end date and time. Null if unknown. | `2026-02-14T22:00:00-06:00` |
| `instance_date` | date | **yes** | Date portion only (YYYY-MM-DD). Used for date-based filtering and grouping. Derived from `start_datetime`. | `2026-02-14` |
| `is_all_day` | boolean | no | True if the event runs all day (no specific start/end time). Default: `false` |
| `timezone` | text | no | IANA timezone identifier. Default: `America/Chicago` | `America/Chicago` |

#### Relationships (foreign keys)

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `category_id` | UUID FK | no | Links to `categories.id`. Determines the event type badge (Music, Art, etc.). One category per event. |
| `location_id` | UUID FK | no | Links to `locations.id`. The venue where the event happens. Null for TBD or online events. |
| `organizer_id` | UUID FK | no | Links to `organizers.id`. Who runs the event. |
| `series_id` | UUID FK | no | Links to `series.id`. Null for standalone events. Set when the event is part of a class, camp, recurring series, etc. |
| `series_sequence` | integer | no | Position within a series. Example: `3` means "Session 3" or "Day 3". Null for standalone events. |
| `is_series_instance` | boolean | no | `true` if this event belongs to a series. Redundant with `series_id IS NOT NULL` but used for query convenience. Default: `false` |
| `is_override` | boolean | no | `true` if this event was manually attached to a series (not generated from the recurrence pattern). Override events are preserved during replenishment — they won't be deleted or recreated. Default: `false` |

#### Pricing

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `price_type` | text | **yes** | How pricing works. **Values:** `free`, `fixed`, `range`, `varies`, `donation`, `per_session`. Default: `free`. CHECK constraint enforced. |
| `price_low` | decimal | no | Lowest price in dollars. Required when `price_type` is `fixed` (the single price) or `range` (the minimum). Example: `15.00` |
| `price_high` | decimal | no | Highest price in dollars. Required when `price_type` is `range`. Must be >= `price_low`. Example: `50.00` |
| `price_details` | text | no | Human-readable pricing notes for complex tiers. Example: "Early bird $15 (ends Feb 1), General $20, Door $25, VIP $50" |
| `is_free` | boolean | auto | **Generated column** — automatically `true` when `price_type = 'free'`. Cannot be set manually. |
| `ticket_url` | text | no | URL to purchase tickets. Shown as "Get Tickets" button on detail page. Takes priority over registration_url and website_url for the primary CTA. |

**Price type values:**

| Value | Meaning | Display | `price_low` | `price_high` |
|-------|---------|---------|-------------|--------------|
| `free` | No cost | "Free" | — | — |
| `fixed` | Single price | "$25" | required | — |
| `range` | Min–max range | "$15 – $50" | required | required |
| `varies` | Variable (tiers, etc.) | "Varies" | optional | optional |
| `donation` | Pay what you want | "Pay What You Can" | optional | optional |
| `per_session` | Price per session | "$10/session" | required | — |

#### Images

Events have three image slots. Each slot has a primary URL plus tracking fields for the hosting pipeline.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `image_url` | text | no | Main hero/landscape image URL. Displayed on event cards and as the detail page hero (only when no flyer exists). Should be a Supabase CDN URL after re-hosting. |
| `thumbnail_url` | text | no | Smaller card image. Used as fallback if `image_url` is missing on cards. Not prominently displayed on the detail page. |
| `flyer_url` | text | no | Poster/flyer image (portrait orientation). Shown at the top of the sidebar on the detail page as a clickable lightbox. When a flyer exists, the hero image is hidden on the detail page. |
| `image_hosted` | boolean | no | `true` if `image_url` has been re-hosted to Supabase Storage. Default: `false` |
| `image_storage_path` | text | no | Supabase Storage path for the hero image. Example: `events/abc-123/hero_1707900000_x4f2.jpg` |
| `raw_image_url` | text | no | Original scraped URL before re-hosting. Kept for debugging if the re-hosted version has issues. |
| `image_validated` | boolean | no | `true` if the image URL has been verified as a valid, loadable image (not a page URL). |
| `image_validated_at` | timestamp | no | When image validation was last run. |
| `image_validation_notes` | text | no | Notes from image validation (e.g., "Rejected: Instagram page URL, not image"). |
| `flyer_hosted` | boolean | no | `true` if `flyer_url` has been re-hosted to Supabase Storage. |
| `flyer_storage_path` | text | no | Supabase Storage path for the flyer image. |
| `thumbnail_hosted` | boolean | no | `true` if `thumbnail_url` has been re-hosted to Supabase Storage. |
| `thumbnail_storage_path` | text | no | Supabase Storage path for the thumbnail. |
| `raw_thumbnail_url` | text | no | Original scraped thumbnail URL before re-hosting. |

##### Image AI generation

Fields for tracking AI-generated hero images (when no scraped image is available or usable).

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `image_ai_generated` | boolean | no | `true` if the hero image was AI-generated. Default: `false` |
| `image_generation_cost` | decimal | no | Cost in dollars for the AI image generation call. |
| `image_generation_prompt` | text | no | The prompt used to generate the image. |
| `image_generation_model` | varchar | no | Model used for generation (e.g., `dall-e-3`). |

##### Image classification & analysis

Fields populated by the image analysis pipeline. Used for admin triage and thumbnail selection.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `image_type` | text | no | Classification of the hero image. Default: `unknown`. Values: `photo`, `flyer`, `thumbnail`, `logo`, `unknown`. |
| `image_text_density` | text | no | How much text is in the image. Default: `unknown`. Values: `none`, `low`, `medium`, `high`, `unknown`. |
| `image_visual_score` | integer | no | Quality score (1–10) assigned by the analysis pipeline. Higher = better for hero display. |
| `image_classifications` | JSONB | no | Full classification output from the analysis pipeline. Shape varies by model. |
| `thumbnail_source` | text | no | Where the thumbnail came from (e.g., `cropped_hero`, `scraped`, `ai_generated`). |
| `flyer_detected` | boolean | no | `true` if the image analysis identified the hero image as a flyer/poster. Default: `false` |
| `flyer_text_content` | text | no | OCR-extracted text content from a detected flyer image. |
| `needs_thumbnail` | boolean | no | `true` if the event needs a better thumbnail (e.g., hero is a flyer, not a photo). Default: `false` |

#### External links

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `website_url` | text | no | Event's own website or landing page. Shown in sidebar links. Also used as fallback "Learn More" CTA when no ticket_url or registration_url exists. |
| `instagram_url` | text | no | Instagram post or profile for the event. Shown in sidebar links. |
| `facebook_url` | text | no | Facebook event page or post. Shown in sidebar links. |
| `registration_url` | text | no | RSVP or registration page. Shown as "Register / RSVP" button when no ticket_url exists. |

#### Audience / age

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `age_low` | integer | no | Minimum age. Example: `21` for a bar show. Shown on event detail page sidebar (as "Ages 21+") and on cards if `age_restriction` is set. |
| `age_high` | integer | no | Maximum age. Must be >= `age_low` if both set. Shown on event detail page sidebar (as "Ages 6-12"). |
| `age_restriction` | text | no | Human-readable age note. Example: "21+", "All ages", "Parental guidance suggested". Shown as orange badge on event cards and in sidebar on detail page. |
| `is_family_friendly` | boolean | no | Whether the event is suitable for families/children. Shown as green "Family Friendly" badge on event cards and in sidebar on detail page. |

#### Good For (audience tags)

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `good_for` | text[] | no | Array of audience/vibe tags. Multiple values per event. Default: `{}` (empty array). Shown as colored pills on event detail page. Filterable on `/events` page. GIN-indexed for efficient `@>` (array contains) queries. |

**Valid values:** `date_night`, `families_young_kids`, `families_older_kids`, `pet_friendly`, `foodies`, `girls_night`, `guys_night`, `solo_friendly`, `outdoorsy`, `creatives`, `music_lovers`, `active_seniors`, `college_crowd`, `first_timers`. See the [Good For tags plan](#planned-good-for-audience-tags) for full descriptions.

#### Status & featuring

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `status` | text | **yes** | Publication state. Default: `draft`. CHECK constraint enforced. See values below. |
| `is_featured` | boolean | no | Whether the event appears in the "Featured" section on the homepage. Default: `false` |
| `featured_order` | integer | no | Sort position within featured events. Lower = earlier. Null if not featured. |

**Event status values:**

| Value | Meaning | Visible to |
|-------|---------|------------|
| `draft` | User is still writing it | Submitter only |
| `pending_review` | Submitted, waiting for admin approval | Submitter + Admin |
| `changes_requested` | Admin wants edits before approving | Submitter + Admin |
| `published` | Live on the site | Everyone |
| `rejected` | Admin rejected the submission | Submitter + Admin |
| `cancelled` | Was live, now cancelled | Everyone (shown with badge) |
| `postponed` | Was live, date now TBD | Everyone (shown with badge) |

#### Submission tracking

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `source` | text | **yes** | Where the event came from. Default: `manual`. CHECK constraint enforced. **Values:** `manual`, `scraper`, `user_submission`, `api`, `import`. |
| `source_url` | text | no | Original URL the event was scraped/imported from. Used for dedup in the scraper API. |
| `source_id` | text | no | External system's ID for this event (e.g., Eventbrite event ID). |
| `scraped_at` | timestamp | no | When the scraper/extension captured this event. |
| `scraped_data` | JSONB | no | Raw JSON blob from the scraper for debugging. Not displayed in the UI. |
| `submitted_by_email` | text | no | Email of the user who submitted the event (for user submissions). |
| `submitted_by_name` | text | no | Display name of the submitter. |
| `submitted_at` | timestamp | no | When the event was submitted for review. |

#### Admin review

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `reviewed_at` | timestamp | no | When an admin last reviewed this event. |
| `reviewed_by` | text | no | Email of the admin who reviewed. |
| `review_notes` | text | no | Internal admin notes (not shown to submitter). |
| `rejection_reason` | text | no | Reason given when rejecting. Shown to the submitter. |
| `change_request_message` | text | no | Message to submitter explaining what changes are needed. Shown on the "my submissions" page. |

#### Edit tracking

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `last_edited_at` | timestamp | no | When the event was last edited (after initial creation). |
| `last_edited_by` | text | no | Email of the person who last edited. |
| `edit_count` | integer | no | How many times the event has been edited. Default: `0` |

#### Soft delete

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `deleted_at` | timestamp | no | When the event was soft-deleted. Null means not deleted. All queries filter `WHERE deleted_at IS NULL`. |
| `deleted_by` | text | no | Email of the person who deleted. |
| `delete_reason` | text | no | Why it was deleted (e.g., "Duplicate", "Spam"). |

#### Engagement

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `heart_count` | integer | no | Number of users who "hearted" (saved) this event. Denormalized — `hearts` table is the source of truth. Default: `0` |
| `view_count` | integer | no | Number of page views. Not currently displayed to users. Default: `0` |

#### SEO

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `meta_title` | text | no | Custom page title for SEO. Falls back to `title` if not set. Only appears in `<head>` tags, never in the visible UI. |
| `meta_description` | text | no | Custom meta description for SEO. Falls back to `short_description` → `description` (truncated to 155 chars). |

---

### 2. series (groups of events)

A series groups multiple events together. Not every event is in a series — standalone events have `series_id = NULL`.

Series cards display significantly more information than event cards — badges for attendance mode, age range, skill level, and extended care are all visible at a glance.

#### Identity

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | UUID | auto | Primary key |
| `title` | text | **yes** | Series name. Example: "Pottery 101 - 6 Week Class" |
| `slug` | text | **yes** | URL-friendly version of title. Must be unique. |
| `description` | text | no | Full description of the series. Shown in "About" section on detail page. |
| `short_description` | text | no | One-line teaser. Used for SEO fallback. Max ~160 characters. |
| `created_at` | timestamp | auto | When the row was created |
| `updated_at` | timestamp | auto | When the row was last modified |
| `published_at` | timestamp | no | When first published |

#### Type

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `series_type` | text | **yes** | What kind of series. CHECK constraint enforced. See values below. |

**Series type values:**

| Value | Meaning | Example |
|-------|---------|---------|
| `class` | Multi-session educational course | "Pottery 101 - 6 weeks" |
| `camp` | Day camp or intensive program | "Summer Art Camp" |
| `workshop` | Workshop series | "Bread Baking - 3 sessions" |
| `recurring` | Regular repeating event | "Weekly Jazz Jam" |
| `festival` | Multi-day festival | "Summerfest" |
| `season` | Performance season | "Symphony 2026 Season" |

#### Schedule

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `start_date` | date | no | First date of the series. Auto-set from generated events if not provided. |
| `end_date` | date | no | Last date of the series. Auto-set from generated events. |
| `total_sessions` | integer | no | Total number of sessions/events in the series. Auto-computed for camps/recurring. |
| `sessions_remaining` | integer | no | How many sessions are still upcoming. Denormalized — maintained by app code. |
| `recurrence_rule` | JSONB | no | Machine-readable recurrence pattern. See [Recurrence Rule](#recurrence-rule-format) below. Only used for `series_type = 'recurring'`. |
| `last_generated_at` | timestamp | no | When events were last generated/replenished for this recurring series. Updated by the replenishment cron and inline generation. |
| `generation_cursor_date` | date | no | Last date through which events have been generated. Replenishment starts from the day after this date. Used to avoid duplicate generation. |

**Recurrence rule format** (JSONB stored on `series.recurrence_rule`):

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `frequency` | text | **yes** | `daily`, `weekly`, `monthly`. Note: `biweekly` is deprecated — use `{ frequency: 'weekly', interval: 2 }` instead. |
| `interval` | integer | **yes** | Every N frequency units. Default: `1`. Example: `2` with `weekly` = every 2 weeks (biweekly). |
| `days_of_week` | integer[] | no | Which days of the week. `0`=Sunday, `1`=Monday, ..., `6`=Saturday. Example: `[1,3,5]` = Mon/Wed/Fri. Used with `weekly` frequency. |
| `day_of_month` | integer | no | For monthly recurrence on a fixed date (1-31). Mutually exclusive with `week_of_month`. |
| `week_of_month` | integer | no | For monthly ordinal patterns: `1`=first, `2`=second, `3`=third, `4`=fourth, `-1`=last. Use with `days_of_week` to express patterns like "First Friday" (`week_of_month: 1, days_of_week: [5]`). Mutually exclusive with `day_of_month`. |
| `time` | text | no | Start time in `HH:MM` format. Example: `"19:00"` |
| `duration_minutes` | integer | no | How long each session lasts in minutes. Example: `90` |
| `end_type` | text | **yes** | How the recurrence ends: `date`, `count`, or `never` |
| `end_date` | text | no | Stop generating after this date (YYYY-MM-DD). Used when `end_type = 'date'`. |
| `end_count` | integer | no | Stop after N occurrences. Used when `end_type = 'count'`. |
| `exclude_dates` | text[] | no | Array of YYYY-MM-DD dates to skip. Events won't be generated on these dates. Populated when an admin cancels a single occurrence or manually adds skip dates (e.g., holidays). |

**Recurrence rule examples:**

| Pattern | JSON |
|---------|------|
| Every Wednesday at 7pm | `{ "frequency": "weekly", "interval": 1, "days_of_week": [3], "time": "19:00", "end_type": "never" }` |
| Every other Thursday, skip holidays | `{ "frequency": "weekly", "interval": 2, "days_of_week": [4], "time": "18:30", "end_type": "never", "exclude_dates": ["2026-11-26", "2026-12-24"] }` |
| First Friday of every month | `{ "frequency": "monthly", "interval": 1, "week_of_month": 1, "days_of_week": [5], "time": "19:00", "end_type": "never" }` |
| Daily for 10 sessions | `{ "frequency": "daily", "interval": 1, "time": "09:00", "duration_minutes": 60, "end_type": "count", "end_count": 10 }` |
| Monthly on the 15th | `{ "frequency": "monthly", "interval": 1, "day_of_month": 15, "time": "12:00", "end_type": "date", "end_date": "2026-12-15" }` |

#### Camp/class fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `attendance_mode` | text | no | How participants attend. Default: `registered`. CHECK constraint: `registered`, `drop_in`, `hybrid`. |
| `skill_level` | text | no | Recommended experience level. CHECK constraint: `beginner`, `intermediate`, `advanced`, `all_levels`. Null if not applicable. |
| `age_low` | integer | no | Minimum age for participants. Example: `6`. Null = no minimum. Shown as badge on cards. |
| `age_high` | integer | no | Maximum age. Must be >= `age_low`. Example: `12`. Null = no maximum. |
| `age_details` | text | no | Human-readable age notes. Example: "Must be potty-trained", "Ages 6-12, younger with parent" |
| `days_of_week` | integer[] | no | Which days the series runs. `0`=Sun through `6`=Sat. Example: `{1,2,3,4,5}` = Mon-Fri. Shown on detail page. |

**Attendance mode values:**

| Value | Meaning | Card badge |
|-------|---------|------------|
| `registered` | Must sign up for the full series | (default, no badge) |
| `drop_in` | Show up to any individual session | "Drop-in Welcome" |
| `hybrid` | Register for series or drop in to sessions | "Register or Drop In" |

**Skill level values:**

| Value | Meaning |
|-------|---------|
| `beginner` | No experience needed |
| `intermediate` | Some experience helpful |
| `advanced` | Experienced practitioners |
| `all_levels` | Open to everyone |

#### Extended care (camps)

For day camps that offer before-care and after-care.

| Field | Type | Required | Description | Example |
|-------|------|----------|-------------|---------|
| `core_start_time` | time | no | Main program start time (HH:MM:SS). | `09:00:00` |
| `core_end_time` | time | no | Main program end time. | `15:00:00` |
| `extended_start_time` | time | no | Before-care/early drop-off start. Null = no before-care. If set, a "Extended Care" badge appears on cards. | `07:30:00` |
| `extended_end_time` | time | no | After-care/late pickup end. Null = no after-care. | `17:30:00` |
| `extended_care_details` | text | no | Human-readable care options and pricing. Example: "Before care 7:30-9am ($25/week). After care 3-5:30pm ($30/week)." |

#### Pricing

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `price_type` | text | no | Same values as events: `free`, `fixed`, `range`, `varies`, `donation`, `per_session`. CHECK constraint. |
| `price_low` | decimal | no | Lowest price. Same rules as events. |
| `price_high` | decimal | no | Highest price. Same rules as events. |
| `price_details` | text | no | Complex pricing text. Shown on detail page. |
| `is_free` | boolean | auto | **Generated column** — `true` when `price_type = 'free'`. |
| `per_session_price` | decimal | no | Drop-in / single-session price. Null = no drop-in option. Example: `15.00`. Shown on detail page as "Drop-in: $15/session". |
| `materials_fee` | decimal | no | Separate materials/supply fee. Null = none. Example: `25.00`. Shown as "Materials fee: $25". |
| `pricing_notes` | text | no | Discounts, early-bird rates, etc. Example: "10% sibling discount. Early bird ends May 1." |

#### Registration

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `registration_url` | text | no | URL to register/sign up. Shown as the primary CTA button on the detail page. Button label adapts to attendance mode. |
| `capacity` | integer | no | Maximum number of registrants. **Not currently displayed.** |
| `waitlist_enabled` | boolean | no | Whether a waitlist is available when full. **Not currently displayed.** Default: `false` |

#### Grouping

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `term_name` | text | no | Semester or session label for grouping. Example: "Fall 2026", "Summer Session A". Shown on detail page. |
| `parent_series_id` | UUID FK | no | Links to another `series.id` for multi-week camp programs. Example: a 2-week camp has 2 child series (Week 1, Week 2) under one parent. **Not currently displayed.** |

#### Relationships, status, engagement, SEO

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `organizer_id` | UUID FK | no | Links to `organizers.id` |
| `category_id` | UUID FK | no | Links to `categories.id` |
| `location_id` | UUID FK | no | Links to `locations.id` |
| `status` | text | no | Same values and CHECK constraint as events. Default: `draft` |
| `is_featured` | boolean | no | Featured on homepage. Default: `false` |
| `featured_order` | integer | no | Sort position in featured section |
| `heart_count` | integer | no | Denormalized save count. Default: `0` |
| `view_count` | integer | no | Page view count. Default: `0` |
| `enrollment_count` | integer | no | Number of registrants. Denormalized. Default: `0` |
| `image_url` | text | no | Main series image |
| `image_hosted` | boolean | no | Whether image is in Supabase Storage |
| `image_storage_path` | text | no | Storage path for image |
| `thumbnail_url` | text | no | Card thumbnail image |
| `meta_title` | text | no | Custom SEO title. Falls back to `title`. |
| `meta_description` | text | no | Custom SEO description. Falls back to `short_description`. |
| `source` | text | no | Origin: `manual`, `scraper`, etc. Default: `manual` |
| `source_url` | text | no | Original URL if imported |

---

### 3. locations (venues)

Where events happen. Called "venues" in the UI but `locations` in the database.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | UUID | auto | Primary key |
| `name` | text | **yes** | Venue name. Example: "Pabst Theater" |
| `slug` | text | **yes** | URL-friendly name. Must be unique. |
| `description` | text | no | About the venue. |
| `address_line` | text | no | Street address. Example: "144 E Wells St" |
| `address_line_2` | text | no | Suite, floor, etc. |
| `city` | text | **yes** | City name. Example: "Milwaukee" |
| `state` | text | no | State abbreviation. Example: "WI" |
| `postal_code` | text | no | ZIP code. Example: "53202" |
| `country` | text | no | Country code. Default: `US` |
| `latitude` | decimal | no | GPS latitude for map display. Example: `43.0389` |
| `longitude` | decimal | no | GPS longitude. Example: `-87.9065` |
| `venue_type` | text | no | Kind of location. Default: `venue`. CHECK constraint enforced. See values below. |
| `website_url` | text | no | Venue's website. |
| `phone` | text | no | Contact phone number. |
| `image_url` | text | no | Venue hero image. |
| `google_place_id` | text | no | Google Maps Place ID for dedup and data enrichment. Example: `ChIJ...` |
| `rating` | decimal | no | Google Maps rating (1.0–5.0). Imported, not user-generated. |
| `review_count` | integer | no | Number of Google reviews. |
| `working_hours` | JSONB | no | Business hours from Google Maps. |
| `google_category` | text | no | Google Maps classification (e.g., "Music venue"). **Not related to the `categories` table.** |
| `source` | text | **yes** | Where this record came from. Default: `manual`. CHECK constraint: `manual`, `scraper`, `csv_import`, `user_submitted`, `api`. |
| `import_batch_id` | text | no | Batch ID if imported via CSV or bulk load. |
| `is_active` | boolean | no | Whether to show in the UI and venue search. Default: `true` |
| `meta_title` | text | no | Custom SEO title. |
| `meta_description` | text | no | Custom SEO description. |
| `created_at` | timestamp | auto | Row creation time |
| `updated_at` | timestamp | auto | Last modification time |

**Venue type values:**

| Value | Meaning | When to use |
|-------|---------|-------------|
| `venue` | General fixed location | Default catch-all for theaters, clubs, studios |
| `outdoor` | Parks, outdoor spaces | Clearly outdoor-primary venues |
| `online` | Virtual/online events | No physical location |
| `various` | Multiple or varying locations | Roaming or pop-up events |
| `tbd` | Location to be announced | Venue not yet confirmed |
| `entertainment` | Theaters, cinemas, bowling | Entertainment-primary venues |
| `arts` | Galleries, museums | Arts/culture-primary venues |
| `sports` | Gyms, stadiums, fields | Sports-primary venues |
| `restaurant` | Restaurants, bars, cafes | Food/drink-primary venues |
| `community` | Community centers, libraries, churches | Community-use-primary |
| `education` | Schools, universities | Education-primary venues |

---

### 4. organizers (who runs events)

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | UUID | auto | Primary key |
| `name` | text | **yes** | Organizer name. Example: "Milwaukee Jazz Collective" |
| `slug` | text | **yes** | URL-friendly name. Must be unique. |
| `description` | text | no | About the organizer. Shown on organizer detail page and in event detail "About the Organizer" section. |
| `logo_url` | text | no | URL to organizer logo image. |
| `website_url` | text | no | Organizer's website. |
| `email` | text | no | Contact email. |
| `phone` | text | no | Contact phone. |
| `social_links` | JSONB | no | Social media URLs. Shape: `{ facebook?: string, instagram?: string, twitter?: string, youtube?: string, tiktok?: string }` |
| `is_verified` | boolean | no | Whether an admin has verified this organizer profile. Default: `false` |
| `is_active` | boolean | no | Whether to show in the UI. Default: `true` |
| `meta_title` | text | no | Custom SEO title. |
| `meta_description` | text | no | Custom SEO description. |
| `created_at` | timestamp | auto | Row creation time |
| `updated_at` | timestamp | auto | Last modification time |

---

### 5. categories (event types)

Static lookup table. Rarely changes. Managed directly in Supabase.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | UUID | auto | Primary key |
| `name` | text | **yes** | Display name. Example: "Music" |
| `slug` | text | **yes** | URL-friendly name for filter params. Example: `music` |
| `description` | text | no | What this category covers. |
| `icon` | text | no | Lucide React icon name for display. Example: `Music`, `Palette`, `GraduationCap` |
| `color` | text | no | Tailwind color class for badge styling. |
| `sort_order` | integer | no | Display order in filter dropdowns and grids. Lower = first. Default: `0` |
| `is_active` | boolean | no | Whether to show in the UI. Inactive categories are hidden from filters but existing events keep their category. Default: `true` |
| `created_at` | timestamp | auto | Row creation time |
| `updated_at` | timestamp | auto | Last modification time |

---

### 6. hearts (saved events)

Users "heart" (save/favorite) events. One row per user-event pair.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | UUID | auto | Primary key |
| `user_id` | UUID FK | **yes** | Links to `auth.users.id`. The user who saved it. |
| `event_id` | UUID FK | **yes** | Links to `events.id`. The event that was saved. |
| `created_at` | timestamp | auto | When the user hearted the event. |

**Constraints:** Unique on `(user_id, event_id)` — a user can't heart the same event twice.

---

### 7. user_follows (following entities)

Users follow organizers, venues, or categories to get notified about new events. Polymorphic — `entity_type` determines which table `entity_id` references.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | UUID | auto | Primary key |
| `user_id` | UUID FK | **yes** | Links to `auth.users.id`. |
| `entity_type` | text | **yes** | What they're following. **Values:** `organizer`, `venue`, `category` |
| `entity_id` | UUID | **yes** | UUID of the followed entity (from `organizers`, `locations`, or `categories`). |
| `notify_new_events` | boolean | no | Whether to send notifications when the followed entity has new events. Default: `true` |
| `created_at` | timestamp | auto | When the follow was created. |

**Constraints:** Unique on `(user_id, entity_type, entity_id)` — can't follow the same thing twice.

---

### 8. profiles (user preferences)

One profile per user, auto-created on sign-up via Supabase trigger.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | UUID | **yes** | Primary key. Matches `auth.users.id` (1:1 relationship). |
| `display_name` | text | no | User's display name. Shown in the UI (e.g., submission attribution). |
| `email` | text | no | User's email address. Synced from auth. |
| `avatar_url` | text | no | URL to profile avatar image. |
| `email_notifications` | boolean | no | Whether to receive email alerts (follows, event updates). Default: `true` |
| `email_weekly_digest` | boolean | no | Whether to receive the weekly events digest email. Default: `false` |
| `timezone` | text | no | IANA timezone for displaying event times. Default: `America/Chicago` |
| `created_at` | timestamp | auto | When the profile was created. |
| `updated_at` | timestamp | auto | When last modified. |

---

### 9. event_drafts (in-progress submissions)

Stores partially-completed event submissions from the 7-step form. Auto-expires after 30 days.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | UUID | auto | Primary key |
| `user_id` | UUID FK | **yes** | Links to `auth.users.id`. Who is drafting. |
| `user_email` | text | **yes** | Submitter's email (denormalized for quick display). |
| `user_name` | text | no | Submitter's display name. |
| `draft_data` | JSONB | no | Partial event fields saved at each form step. Shape matches `EventDraftData` in `types/submission.ts`. |
| `series_draft_data` | JSONB | no | Partial series fields if the user is creating a new series alongside the event. Shape matches `SeriesDraftData`. |
| `current_step` | integer | no | Which form step the user is currently on (1–7). |
| `completed_steps` | integer[] | no | Array of step numbers the user has completed. Example: `{1, 2, 3}` |
| `submitted_event_id` | UUID FK | no | Links to `events.id` after the draft is submitted. Null while still in draft. |
| `expires_at` | timestamp | **yes** | Auto-cleanup date. Set to 30 days from creation. Expired drafts can be purged. |
| `created_at` | timestamp | auto | When the draft was started. |
| `updated_at` | timestamp | auto | When last saved. |

---

### 10. organizer_users (organizer claims)

Junction table linking users to the organizer profiles they manage. Supports team access.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | UUID | auto | Primary key |
| `user_id` | UUID FK | **yes** | Links to `auth.users.id`. |
| `organizer_id` | UUID FK | **yes** | Links to `organizers.id`. |
| `role` | text | **yes** | User's role on the organizer team. **Values:** `member` (can view), `admin` (can edit events). |
| `status` | text | **yes** | Claim verification status. **Values:** `pending` (awaiting admin approval), `verified` (approved), `rejected`. |
| `created_at` | timestamp | auto | When the claim was made. |

---

### 11. admin_audit_log (activity tracking)

Every admin action is logged here. Append-only — rows are never updated or deleted.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | UUID | auto | Primary key |
| `action` | text | **yes** | What happened. Examples: `event_approved`, `event_rejected`, `event_changes_requested`, `event_deleted`, `event_resubmitted`, `event_edited` |
| `entity_type` | text | **yes** | What kind of thing was acted on. **Values:** `event`, `series`, `organizer` |
| `entity_id` | UUID | **yes** | Which specific entity. Links to `events.id`, `series.id`, or `organizers.id`. |
| `admin_email` | text | **yes** | Email of the admin who performed the action. |
| `changes` | JSONB | no | Diff of what changed. Shape: `{ field: { old: value, new: value } }` |
| `notes` | text | no | Free-text admin notes explaining the action. |
| `created_at` | timestamp | auto | When the action happened. |

---

## Relationship Diagram

```
categories ──1:N──► events ◄──N:1── locations
                       │                  │
                       │                  └── google_place_id (dedup)
                       │
organizers ──1:N──► events
     │
     └──1:N──► series ──1:N──► events
                  │
                  └── parent_series_id (self-ref, for multi-week camp programs)

auth.users ──1:1──► profiles
     │
     ├──1:N──► hearts ◄──N:1── events
     │
     ├──1:N──► user_follows ──► (organizers | locations | categories)
     │
     ├──1:N──► event_drafts
     │
     └──1:N──► organizer_users ◄──N:1── organizers
```

---

## Design Notes

### `is_free` is a generated column

`is_free` on both `events` and `series` is a **PostgreSQL generated column**: it automatically equals `price_type = 'free'`. You cannot set it manually in INSERT or UPDATE statements — it's always computed from `price_type`. This guarantees the two fields can never drift out of sync.

### `google_category` on locations

The `google_category` column on the `locations` table holds a Google Maps classification (e.g., "Music venue", "Restaurant"). This is completely separate from the `categories` table, which holds Happenlist's own event taxonomy (e.g., "Music", "Art"). The column was renamed from `category` to `google_category` to avoid confusion.

### CHECK constraints on enum columns

All TEXT enum columns have database-level CHECK constraints that prevent invalid values:
- `events.status`: draft, pending_review, changes_requested, published, rejected, cancelled, postponed
- `events.price_type`: free, fixed, range, varies, donation, per_session
- `series.series_type`: class, camp, workshop, recurring, festival, season
- `series.status`: same as events
- `series.price_type`: same as events
- `series.attendance_mode`: registered, drop_in, hybrid
- `series.skill_level`: beginner, intermediate, advanced, all_levels
- `locations.venue_type`: venue, outdoor, online, various, tbd, entertainment, arts, sports, restaurant, community, education

### Denormalized counts

`events.heart_count` and `series.heart_count` are denormalized — the `hearts` table is the source of truth. Similarly, `series.sessions_remaining` and `series.enrollment_count` need to be kept in sync with actual data. These exist for query performance and are maintained by app-level code.

### Description fields on events

Events have four separate text fields for descriptions. Three are displayed on the event detail page; one is retained for SEO/search purposes only.

| Field | What it is | Who writes it | UI location | Example |
|-------|-----------|---------------|-------------|---------|
| `short_description` | One-line teaser | Admin/scraper | Italic text directly below the event title | "Live jazz at the Pabst Theater" (max ~160 chars) |
| `happenlist_summary` | Editorial third-person summary | Scraper (AI-generated) | Highlighted "Happenlist Highlights" box (coral background, Sparkles icon) | "This intimate jazz show highlights three of Milwaukee's finest..." |
| `organizer_description` | Verbatim copy from the source | Scraper/submitter | Quoted "From the Organizer" section (italic, Quote icon) | The exact text from the event page, preserving original formatting |
| `description` | General cleaned-up description | Admin/scraper | **Not displayed on detail page** (SEO fallback only) | "Live jazz featuring the Milwaukee Trio..." |

**Display order on the detail page:** short_description (under title) → good_for pills → happenlist_summary → organizer_description. All are optional — sections only render when populated.

**SEO fallback chain:** `meta_description` → `short_description` → `description` (truncated to 155 chars).

For CSV exports, `description` and `short_description` are the most useful. `organizer_description` preserves the original source text for reference.

### Source values

The `source` field on events tracks where the event came from. Current values used:

| Value | Meaning |
|-------|---------|
| `manual` | Created by an admin in the database (default) |
| `scraper` | Imported by the Chrome extension or automated scraper |
| `user_submission` | Submitted through the website's submission form |
| `api` | Created via API |
| `import` | Bulk imported |

**Note:** A CHECK constraint was added in migration `20260211`. The `source_url` field stores the original URL the event was scraped/imported from.

### Dropped legacy columns (migration `20260211`)

These columns were removed from the database. Listed here for historical reference:

| Column | Original purpose | Why removed |
|--------|-----------------|-------------|
| `event_type` | Categorize event format | Never implemented; `series_type` on series table serves this purpose |
| `recurrence_parent_id` | Link recurring instances to a template | Replaced by the series system (`series_type = 'recurring'`) |
| `is_recurrence_template` | Mark an event as a recurrence template | Replaced by the series system |
| `recurrence_pattern` | JSON recurrence rules on events | Replaced by `series.recurrence_rule` |
| `on_sale_date` | When tickets go on sale | Never implemented in the UI |

### Unused fields on events (exist but not displayed)

| Column | Status | Notes |
|--------|--------|-------|
| `view_count` | **Not displayed** | Tracked in DB but never shown to users (heart_count IS shown). |

### Unused fields on series

| Column | Status | Notes |
|--------|--------|-------|
| `parent_series_id` | **Not displayed** | Self-referencing FK for grouping series into programs. Schema supports it but no UI renders it. |
| `capacity` | **Not displayed** | Exists in DB, never shown in cards or detail pages. |
| `waitlist_enabled` | **Not displayed** | Same — exists but not surfaced. |

### Venue type ambiguity

The `venue_type` values mix two concepts: **physical type** (`venue`, `outdoor`, `online`, `various`, `tbd`) and **domain/purpose** (`entertainment`, `arts`, `sports`, `restaurant`, `community`, `education`). In practice:

- Use `outdoor`, `online`, `various`, or `tbd` when those clearly apply
- Use a domain type (`restaurant`, `education`, etc.) when the venue is primarily known for that purpose
- Use `venue` as the default/catch-all for general-purpose spaces (theaters, clubs, studios)
